# Пакетная обработка аудио файлов с помощью WebRTC AEC

Скрипт `batch_aec_test.py` предназначен для пакетной обработки предварительно подготовленных пар аудиофайлов с использованием алгоритма подавления акустического эха (AEC) от WebRTC.

## Особенности

- **Пакетная обработка:** Автоматическая обработка всех тестовых поддиректорий в каталогах `tests/music` и `tests/agent_speech`.
- **Разные уровни громкости:** Поддержка тестирования с различными уровнями громкости (поддиректории вида `reference_XX`).
- **Подробная статистика:** Расчёт и сохранение метрик качества подавления эха для каждого теста.
- **Визуализация:** Автоматическое создание графиков сигналов и зависимостей метрик от уровня громкости.
- **Сводный отчёт:** Генерация общего отчета в формате JSON по всем тестам.
- **Локальные логи:** Сохранение отдельных лог-файлов для каждой обрабатываемой директории.

## Требования

- Python 3.6+
- Библиотеки: numpy, matplotlib, soundfile, scipy
- Установленный модуль WebRTC AEC

## Установка

```bash
pip install -r requirements.txt
```

## Подготовка тестовых данных

Перед запуском этого скрипта вам необходимо подготовить тестовые данные с помощью скрипта `prepare_tests.py` в директории `tests`:

```bash
cd tests
python prepare_tests.py
```

Это создаст соответствующие поддиректории с тестовыми аудиофайлами разной громкости.

## Использование

### Запуск для всех тестов

```bash
python batch_aec_test.py
```

При запуске без дополнительных параметров, результаты обработки будут сохранены в тех же директориях, где находятся исходные файлы. Сводный отчет будет сохранен в директории `results_summary`.

### Сохранение результатов в отдельную директорию

```bash
python batch_aec_test.py --results-dir results_2023-05-20
```

При использовании параметра `--results-dir` все результаты, включая обработанные файлы, визуализации и сводный отчет, будут сохранены в указанной директории с сохранением структуры поддиректорий.

### Другие параметры

```bash
python batch_aec_test.py --help
```

```
usage: batch_aec_test.py [-h] [--tests-dir TESTS_DIR] [--results-dir RESULTS_DIR] [--visualize] 
                         [--no-visualize] [--frame-size-ms FRAME_SIZE_MS] [--verbose]

Пакетная обработка тестовых данных с WebRTC AEC

optional arguments:
  -h, --help            show this help message and exit
  --tests-dir TESTS_DIR, -t TESTS_DIR
                        Директория с тестовыми данными (по умолчанию: tests)
  --results-dir RESULTS_DIR, -r RESULTS_DIR
                        Директория для сохранения результатов (по умолчанию: исходные директории)
  --visualize, -v       Создавать визуализации (по умолчанию: включено)
  --no-visualize        Не создавать визуализации
  --frame-size-ms FRAME_SIZE_MS, -f FRAME_SIZE_MS
                        Размер фрейма в миллисекундах (по умолчанию: 10.0)
  --verbose             Подробный вывод
```

## Структура результатов

После запуска скрипта в каждой тестовой директории будут созданы следующие файлы:

```
tests/
├── music/
│   ├── reference_01/
│   │   ├── reference_volumed.wav          # Референсный сигнал без задержки, с измененной громкостью 
│   │   ├── reference_volumed_delayed.wav  # Референсный сигнал с задержкой и измененной громкостью
│   │   └── original_input.wav             # Смесь my_voice.wav и reference_volumed_delayed.wav
│   │   ├── processed_input.wav        # Обработанный файл с AEC
│   │   ├── aec_metrics.json           # Метрики качества AEC
│   │   ├── aec_processing.log         # Локальный лог-файл
│   │   ├── aec_signals.png            # Визуализация сигналов
│   │   ├── aec_delay.png              # Визуализация задержки
│   │   └── ...
│   ├── reference_04/
│   │   └── ...
│   └── ...
└── agent_speech/
    └── ...

results_summary/              # Директория со сводными результатами
├── aec_summary_report.json   # Сводный отчет по всем тестам
├── charts/                   # Графики зависимостей метрик от громкости
│   ├── music_erle_db.png
│   ├── music_snr_db.png
│   └── ...
```

При использовании параметра `--results-dir` создается аналогичная структура в указанной директории.

## Метрики и их интерпретация

Скрипт рассчитывает следующие метрики качества:

- **MSE (Mean Squared Error)**: Среднеквадратичная ошибка между обработанным и референсным сигналами. Чем меньше, тем лучше.
- **NMSE (Normalized MSE)**: Нормализованная среднеквадратичная ошибка. Чем меньше, тем лучше.
- **SNR (Signal-to-Noise Ratio)**: Отношение сигнал/шум в дБ. Чем больше, тем лучше.
- **Correlation**: Корреляция между обработанным и референсным сигналами. Чем меньше, тем лучше (меньше остаточного эха).
- **ERLE (Echo Return Loss Enhancement)**: Эффективность подавления эха в дБ. Чем больше, тем лучше.
- **Echo Frames**: Количество и процент фреймов, в которых обнаружено эхо. Чем меньше, тем лучше.

## Рекомендации по анализу результатов

1. **Сравнение разных уровней громкости**: Изучите графики зависимостей метрик от уровня громкости, чтобы определить, как качество AEC меняется при изменении громкости.
2. **Прослушивание обработанных файлов**: Для качественной оценки прослушайте обработанные файлы в каждой директории.
3. **Анализ проблемных участков**: Если некоторые метрики показывают плохие результаты, изучите соответствующие визуализации, чтобы понять, на каких участках возникают проблемы.
4. **Проверка локальных логов**: В каждой директории создается отдельный лог-файл `aec_processing.log`, содержащий подробную информацию о процессе обработки конкретной пары файлов.

## Устранение проблем

При возникновении проблем проверьте:

1. Наличие файлов `reference_volumed_delayed.wav` и `original_input.wav` в каждой тестовой поддиректории.
2. Соответствие формата аудиофайлов ожидаемому (частота дискретизации, количество каналов).
3. Локальные логи в файлах `aec_processing.log` в каждой поддиректории для выявления специфических ошибок.
4. Общий лог в файле `batch_aec_test.log` для выявления глобальных проблем.

### Известные проблемы и их решения

#### Ошибка "Object of type float32 is not JSON serializable"

Данная ошибка возникает при сохранении метрик в JSON-формате, когда в метриках присутствуют NumPy-типы (например, `np.float32`). Текущая версия скрипта включает специальный класс `NumpyJSONEncoder` для корректной сериализации этих типов.

Если вы все же столкнулись с этой ошибкой, убедитесь, что:
- Используется последняя версия скрипта
- Все импорты корректно выполнены
- Версии NumPy и JSON-библиотек совместимы

#### Обрезанные аудиофайлы (неполная обработка)

Если вы обнаружили, что выходные файлы `processed_input.wav` имеют длительность значительно меньше, чем входные файлы:

1. Проверьте локальные логи (`aec_processing.log`) на наличие ошибок при обработке фреймов.
2. Убедитесь, что используется оптимизированная функция обработки аудио (`optimized_process_audio_with_aec`).
3. Проверьте, что размер фрейма (`frame_size_ms`) соответствует вашим данным. По умолчанию используется 10 мс, что является оптимальным для большинства случаев.
4. Если проблема сохраняется, попробуйте использовать параметр `--verbose` для получения подробного лога обработки.

#### Ошибки визуализации

Если при генерации визуализаций возникают ошибки:

1. Убедитесь, что модуль `matplotlib` установлен и корректно работает.
2. Проверьте, что путь к директории для сохранения результатов существует и у вас есть права на запись.
3. Если визуализация не требуется, используйте параметр `--no-visualize`.

#### Ошибки WebRTC AEC

Если при обработке возникают ошибки, связанные с модулем WebRTC AEC:

1. Проверьте, что библиотека `webrtc-audio-processing` корректно установлена.
2. Убедитесь, что используемые аудиофайлы имеют поддерживаемый формат (WAV-файлы, моно или стерео, 16-битный PCM).
3. Проверьте логи на наличие конкретных ошибок из модуля WebRTC.

## Автор

- Разработано для проекта AudioEchoCancellation 