# Подготовка тестовых данных для аудиотестов

Данный набор скриптов позволяет подготовить тестовые аудиоданные с различными уровнями громкости для тестирования алгоритмов шумоподавления и эхокомпенсации.

## Структура директорий

- `music/`: Тесты с музыкальными аудиофайлами
- `agent_speech/`: Тесты с речью агента
- `create_volume_variants.py`: Общий скрипт для создания вариантов с разной громкостью
- `prepare_tests.py`: Основной скрипт для подготовки всех тестов

## Быстрый запуск

Для подготовки всех тестовых данных выполните:

```bash
cd tests
python prepare_tests.py
```

Скрипт автоматически создаст необходимые поддиректории и файлы с разными уровнями громкости.

Если вы хотите обработать только одну конкретную директорию, можно использовать:

```bash
cd tests
python create_volume_variants.py music  # для обработки только директории music
```

## Подробная информация

Для каждой директории с тестами будут созданы поддиректории:

- `reference_01/`: содержит файл с громкостью 10% от исходной
- `reference_04/`: содержит файл с громкостью 40% от исходной
- `reference_07/`: содержит файл с громкостью 70% от исходной
- `reference_10/`: содержит файл с исходной громкостью (100%)
- `reference_13/`: содержит файл с увеличенной громкостью (130%)

В каждой поддиректории будут созданы следующие файлы:
- `reference_new.wav` - аудиофайл с измененной громкостью
- `original_input.wav` - микшированный файл, содержащий звук с измененной громкостью и голос пользователя (имитация записи микрофоном)

## Файлы с голосом пользователя

Для создания микшированных файлов `original_input.wav` в каждой директории с тестами должен быть файл с голосом пользователя:
- `my_voice.wav` или `my_voice.mp3`

Если файл имеет формат MP3, он будет автоматически конвертирован в WAV с помощью ffmpeg. Скрипт также проверяет соответствие частоты дискретизации между файлами reference.wav и my_voice.wav и при необходимости приводит их к одинаковому формату.

## Особенности обработки аудио

Скрипт выполняет следующие преобразования для корректного микширования:
1. Проверяет и выравнивает частоту дискретизации обоих файлов
2. Корректно обрабатывает моно/стерео форматы, преобразуя их для правильного микширования
3. Нормализует выходной сигнал для предотвращения клиппинга и искажений
4. Выполняет синхронизацию длины аудиофайлов

## Требования

Для работы скриптов необходимы следующие библиотеки Python:
```
numpy
soundfile
```

Установка библиотек:
```bash
pip install numpy soundfile
```

Для автоматической конвертации MP3 в WAV **обязательно** требуется установить ffmpeg:
```bash
# Ubuntu/Debian
sudo apt-get install ffmpeg

# Windows (с использованием Chocolatey)
choco install ffmpeg

# macOS (с использованием Homebrew)
brew install ffmpeg
```

## Как это работает

1. Основной скрипт `prepare_tests.py`:
   - Проверяет наличие ffmpeg в системе
   - Проходит по всем директориям тестов
   - Для каждой директории проверяет наличие необходимых файлов
   - Вызывает общий скрипт для обработки каждой директории

2. Скрипт `create_volume_variants.py`:
   - Получает параметры (частоту дискретизации, формат) референсного файла
   - Конвертирует MP3 в WAV с правильной частотой дискретизации, если необходимо
   - Проверяет и корректирует несоответствия в формате между файлами
   - Создаёт поддиректории с файлами разной громкости
   - Микширует аудиофайлы для получения "оригинального" входного сигнала

## Настройка

При необходимости вы можете изменить используемые коэффициенты громкости, отредактировав словарь `VOLUME_LEVELS` в скрипте `create_volume_variants.py`. 