# Подготовка тестовых данных для аудиотестов

Данный набор скриптов позволяет подготовить тестовые аудиоданные с различными уровнями громкости для тестирования алгоритмов шумоподавления и эхокомпенсации.

## Структура директорий

- `music/`: Тесты с музыкальными аудиофайлами
- `agent_speech/`: Тесты с речью агента
- `create_volume_variants.py`: Общий скрипт для создания вариантов с разной громкостью
- `prepare_tests.py`: Основной скрипт для подготовки всех тестов

## Быстрый запуск

Для подготовки всех тестовых данных выполните:

```bash
cd tests
python prepare_tests.py
```

Скрипт автоматически создаст необходимые поддиректории и файлы с разными уровнями громкости.

Если вы хотите обработать только одну конкретную директорию, можно использовать:

```bash
cd tests
python create_volume_variants.py music  # для обработки только директории music
```

## Подробная информация

Для каждой директории с тестами создается следующая структура:

```
music/
│
├── clear_reference/           # Директория для чистого референсного сигнала
│   ├── reference_01/          # 10% громкости
│   ├── reference_04/          # 40% громкости
│   ├── reference_07/          # 70% громкости
│   ├── reference_10/          # 100% громкости (исходная)
│   └── reference_13/          # 130% громкости
│
└── reference_by_micro/        # Директория для референса через микрофон
    ├── reference_01/
    ├── reference_04/
    ├── reference_07/
    ├── reference_10/
    └── reference_13/
```

В каждой поддиректории `reference_XX/` будут созданы следующие файлы:
- `reference_new.wav` - аудиофайл с измененной громкостью (на основе соответствующего референсного сигнала)
- `original_input.wav` - микшированный файл, содержащий голос пользователя и 
  соответствующий референсный сигнал с примененным коэффициентом громкости

## Необходимые входные файлы

Для корректной работы скрипта в каждой тестовой директории должны быть следующие файлы:
- `reference.wav` - чистый референсный сигнал
- `reference_by_micro.wav` - запись референса через микрофон
- `my_voice.wav` или `my_voice.mp3` - запись голоса пользователя

Если файл имеет формат MP3, он будет автоматически конвертирован в WAV с помощью ffmpeg. Скрипт также проверяет соответствие частоты дискретизации между файлами и при необходимости приводит их к одинаковому формату.

## Особенности обработки аудио

Скрипт выполняет следующие преобразования для корректного микширования:
1. Проверяет и выравнивает частоту дискретизации всех файлов
2. Корректно обрабатывает моно/стерео форматы, преобразуя их для правильного микширования
3. Нормализует выходной сигнал для предотвращения клиппинга и искажений
4. Выполняет синхронизацию длины аудиофайлов
5. Создает отдельные поддиректории для каждого типа референсного сигнала и уровня громкости
6. Применяет одинаковые коэффициенты громкости к обоим типам референсных сигналов

## Требования

Для работы скриптов необходимы следующие библиотеки Python:
```
numpy
soundfile
```

Установка библиотек:
```bash
pip install numpy soundfile
```

Для автоматической конвертации MP3 в WAV **обязательно** требуется установить ffmpeg:
```bash
# Ubuntu/Debian
sudo apt-get install ffmpeg

# Windows (с использованием Chocolatey)
choco install ffmpeg

# macOS (с использованием Homebrew)
brew install ffmpeg
```

## Как это работает

1. Основной скрипт `prepare_tests.py`:
   - Проверяет наличие ffmpeg в системе
   - Проходит по всем директориям тестов
   - Для каждой директории проверяет наличие необходимых файлов
   - Вызывает общий скрипт для обработки каждой директории

2. Скрипт `create_volume_variants.py`:
   - Получает параметры обоих референсных файлов (reference.wav и reference_by_micro.wav)
   - Конвертирует MP3 в WAV с правильной частотой дискретизации, если необходимо
   - Проверяет и корректирует несоответствия в формате между файлами
   - Для каждого типа референса (чистый и через микрофон):
     - Создает отдельную поддиректорию
     - Для каждого уровня громкости:
       - Создает поддиректорию с соответствующим уровнем громкости
       - Создает reference_new.wav с измененной громкостью
       - Микширует голос пользователя с соответствующим референсным сигналом 
         для создания original_input.wav

## Настройка

При необходимости вы можете изменить используемые коэффициенты громкости, отредактировав словарь `VOLUME_LEVELS` в скрипте `create_volume_variants.py`. 